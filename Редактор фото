"""
–†–ï–î–ê–ö–¢–û–† –§–û–¢–û –° –°–ï–¢–ö–û–ô –î–õ–Ø –í–ò–ó–ò–¢–û–ö
–í—Å–µ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ - –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç–µ!

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install Pillow
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: python photo_grid_all_in_one.py
3. –†–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ø–∞–ø–∫–µ output/
"""

from PIL import Image, ImageDraw
import os


# ============================================
# –ö–õ–ê–°–° –î–õ–Ø –°–û–ó–î–ê–ù–ò–Ø –°–ï–¢–ö–ò
# ============================================

class PhotoEditor:
    """–ö–ª–∞—Å—Å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–æ–Ω–∞ –∏ —Å–µ—Ç–∫–∏ –¥–ª—è –≤–∏–∑–∏—Ç–æ–∫"""
    
    def __init__(self, width=1080, height=1080):
        self.width = width
        self.height = height
        self.image = None
    
    def create_floor_wall_background(self, 
                                    wall_color=(240, 240, 245),
                                    floor_color=(200, 180, 160),
                                    horizon_position=0.6,
                                    wall_image=None,
                                    floor_image=None):
        """–°–æ–∑–¥–∞–µ—Ç —Ñ–æ–Ω —Å —Å—Ç–µ–Ω–æ–π –∏ –ø–æ–ª–æ–º"""
        self.image = Image.new('RGB', (self.width, self.height), wall_color)
        horizon_y = int(self.height * horizon_position)
        
        if wall_image:
            wall_img = Image.open(wall_image).convert('RGB')
            wall_img = wall_img.resize((self.width, horizon_y), Image.Resampling.LANCZOS)
            self.image.paste(wall_img, (0, 0))
        else:
            draw = ImageDraw.Draw(self.image)
            draw.rectangle([(0, 0), (self.width, horizon_y)], fill=wall_color)
        
        if floor_image:
            floor_img = Image.open(floor_image).convert('RGB')
            floor_height = self.height - horizon_y
            floor_img = floor_img.resize((self.width, floor_height), Image.Resampling.LANCZOS)
            self.image.paste(floor_img, (0, horizon_y))
        else:
            draw = ImageDraw.Draw(self.image)
            draw.rectangle([(0, horizon_y), (self.width, self.height)], fill=floor_color)
        
        if not wall_image and not floor_image:
            draw = ImageDraw.Draw(self.image)
            for i in range(20):
                alpha = i / 20
                blend_color = tuple(
                    int(wall_color[j] * (1 - alpha) + floor_color[j] * alpha)
                    for j in range(3)
                )
                draw.line(
                    [(0, horizon_y + i), (self.width, horizon_y + i)],
                    fill=blend_color,
                    width=1
                )
        
        return self.image
    
    def add_grid(self, rows=3, cols=3, 
                 grid_color=(150, 150, 150),
                 line_width=2,
                 margin=50):
        """–î–æ–±–∞–≤–ª—è–µ—Ç —Å–µ—Ç–∫—É –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≤–∏–∑–∏—Ç–æ–∫"""
        if self.image is None:
            raise ValueError("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Ñ–æ–Ω!")
        
        draw = ImageDraw.Draw(self.image)
        work_width = self.width - 2 * margin
        work_height = self.height - 2 * margin
        cell_width = work_width / cols
        cell_height = work_height / rows
        
        for i in range(cols + 1):
            x = margin + i * cell_width
            draw.line([(x, margin), (x, self.height - margin)], 
                     fill=grid_color, width=line_width)
        
        for i in range(rows + 1):
            y = margin + i * cell_height
            draw.line([(margin, y), (self.width - margin, y)], 
                     fill=grid_color, width=line_width)
        
        return self.image
    
    def get_cell_coordinates(self, row, col, rows=3, cols=3, margin=50):
        """–ü–æ–ª—É—á–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —è—á–µ–π–∫–∏"""
        work_width = self.width - 2 * margin
        work_height = self.height - 2 * margin
        cell_width = work_width / cols
        cell_height = work_height / rows
        
        x1 = margin + col * cell_width
        y1 = margin + row * cell_height
        x2 = x1 + cell_width
        y2 = y1 + cell_height
        
        return (int(x1), int(y1), int(x2), int(y2))
    
    def place_image_in_cell(self, image_path, row, col, 
                           rows=3, cols=3, margin=50, padding=10):
        """–†–∞–∑–º–µ—â–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–≤–∏–∑–∏—Ç–∫—É) –≤ —è—á–µ–π–∫–µ"""
        if self.image is None:
            raise ValueError("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Ñ–æ–Ω!")
        
        x1, y1, x2, y2 = self.get_cell_coordinates(row, col, rows, cols, margin)
        card_image = Image.open(image_path)
        
        cell_width = x2 - x1 - 2 * padding
        cell_height = y2 - y1 - 2 * padding
        card_image.thumbnail((cell_width, cell_height), Image.Resampling.LANCZOS)
        
        paste_x = x1 + padding + (cell_width - card_image.width) // 2
        paste_y = y1 + padding + (cell_height - card_image.height) // 2
        
        if card_image.mode == 'RGBA':
            self.image.paste(card_image, (paste_x, paste_y), card_image)
        else:
            self.image.paste(card_image, (paste_x, paste_y))
        
        return self.image
    
    def set_background_image(self, background_path):
        """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≥–æ—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ —Ñ–æ–Ω"""
        bg_image = Image.open(background_path).convert('RGB')
        self.image = bg_image.resize((self.width, self.height), Image.Resampling.LANCZOS)
        return self.image
    
    def create_textured_background(self, texture_path, tile=True):
        """–°–æ–∑–¥–∞–µ—Ç —Ñ–æ–Ω –∏–∑ —Ç–µ–∫—Å—Ç—É—Ä—ã"""
        texture = Image.open(texture_path).convert('RGB')
        
        if tile:
            self.image = Image.new('RGB', (self.width, self.height))
            texture_width, texture_height = texture.size
            
            for y in range(0, self.height, texture_height):
                for x in range(0, self.width, texture_width):
                    self.image.paste(texture, (x, y))
        else:
            self.image = texture.resize((self.width, self.height), Image.Resampling.LANCZOS)
        
        return self.image
    
    def save(self, output_path):
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"""
        if self.image is None:
            raise ValueError("–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!")
        
        os.makedirs(os.path.dirname(output_path) if os.path.dirname(output_path) else '.', exist_ok=True)
        self.image.save(output_path, quality=95)
        return output_path
    
    def show(self):
        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"""
        if self.image is None:
            raise ValueError("–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è!")
        self.image.show()


# ============================================
# –ü–†–ò–ú–ï–†–´ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø
# ============================================

def example_1():
    """–ü—Ä–∏–º–µ—Ä 1: –ü—Ä–æ—Å—Ç–∞—è —Å–µ—Ç–∫–∞ 3x3"""
    print("\nüì∏ –ü—Ä–∏–º–µ—Ä 1: –ü—Ä–æ—Å—Ç–∞—è —Å–µ—Ç–∫–∞ 3x3")
    
    editor = PhotoEditor(width=1080, height=1080)
    editor.create_floor_wall_background(
        wall_color=(245, 245, 250),
        floor_color=(210, 180, 140),
        horizon_position=0.5
    )
    editor.add_grid(rows=3, cols=3, margin=60)
    editor.save('output/example_1_simple_grid.jpg')
    
    print("   ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: output/example_1_simple_grid.jpg")


def example_2():
    """–ü—Ä–∏–º–µ—Ä 2: –°–µ—Ç–∫–∞ 2x4 —Å –¥—Ä—É–≥–∏–º–∏ —Ü–≤–µ—Ç–∞–º–∏"""
    print("\nüì∏ –ü—Ä–∏–º–µ—Ä 2: –°–µ—Ç–∫–∞ 2x4 —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ —Ü–≤–µ—Ç–∞–º–∏")
    
    editor = PhotoEditor(width=1080, height=1350)
    editor.create_floor_wall_background(
        wall_color=(255, 250, 240),
        floor_color=(139, 90, 60),
        horizon_position=0.6
    )
    editor.add_grid(rows=2, cols=4, margin=80, grid_color=(200, 200, 200), line_width=3)
    editor.save('output/example_2_custom_colors.jpg')
    
    print("   ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: output/example_2_custom_colors.jpg")


def example_3():
    """–ü—Ä–∏–º–µ—Ä 3: –ë–æ–ª—å—à–∞—è —Å–µ—Ç–∫–∞ –¥–ª—è Instagram Stories"""
    print("\nüì∏ –ü—Ä–∏–º–µ—Ä 3: –°–µ—Ç–∫–∞ –¥–ª—è Instagram Stories (1080x1920)")
    
    editor = PhotoEditor(width=1080, height=1920)
    editor.create_floor_wall_background(
        wall_color=(240, 235, 230),
        floor_color=(180, 160, 140),
        horizon_position=0.5
    )
    editor.add_grid(rows=4, cols=3, margin=60)
    editor.save('output/example_3_stories.jpg')
    
    print("   ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: output/example_3_stories.jpg")


# ============================================
# –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø
# ============================================

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è - –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ –ø—Ä–∏–º–µ—Ä—ã"""
    print("=" * 60)
    print("üé® –†–ï–î–ê–ö–¢–û–† –§–û–¢–û –° –°–ï–¢–ö–û–ô –î–õ–Ø –í–ò–ó–ò–¢–û–ö")
    print("=" * 60)
    
    try:
        # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–º–µ—Ä—ã
        example_1()
        example_2()
        example_3()
        
        print("\n" + "=" * 60)
        print("‚ú® –ì–û–¢–û–í–û! –í—Å–µ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ output/")
        print("=" * 60)
        
        print("\nüìù –ö–ê–ö –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨:")
        print("   1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø–∞–ø–∫—É output/ –∏ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ø—Ä–∏–º–µ—Ä—ã")
        print("   2. –ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–∏ —Ñ–æ–Ω—ã:")
        print("      - –°–æ–∑–¥–∞–π—Ç–µ –ø–∞–ø–∫—É backgrounds/")
        print("      - –ü–æ–ª–æ–∂–∏—Ç–µ —Ç—É–¥–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")
        print("      - –ò–∑–º–µ–Ω–∏—Ç–µ –∫–æ–¥: wall_image='backgrounds/wall.jpg'")
        print("   3. –ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –≤–∏–∑–∏—Ç–∫–∏:")
        print("      - –°–æ–∑–¥–∞–π—Ç–µ –ø–∞–ø–∫—É cards/")
        print("      - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ place_image_in_cell()")
        
        print("\nüí° –°–û–í–ï–¢: –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª –ø–æ–¥ —Å–≤–æ–∏ –Ω—É–∂–¥—ã!")
        
    except Exception as e:
        print(f"\n‚ùå –û–®–ò–ë–ö–ê: {e}")
        print("\nüîß –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ Pillow:")
        print("   pip install Pillow")


if __name__ == "__main__":
    main()

